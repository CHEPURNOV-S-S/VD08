{% extends "base.html" %}

{% block title %}
    Профиль пользователя
{% endblock %}

{% block content %}
    <div class="container mt-5">
        <h1>Профиль пользователя</h1>

        <!-- Отображение информации о пользователе -->
        <div class="row">
            <div class="col-md-4">
                <img src="{{ user_photo }}" alt="Фото пользователя" class="rounded-circle" style="width: 200px; height: 200px; object-fit: cover;">
                <!-- Кнопка "Обновить фото" -->
                <a href="#" id="update-photo-btn" class="btn btn-primary mb-3">
                    <i class="fas fa-camera"></i> Обновить фото
                </a>

                <!-- Форма загрузки фото (скрыта по умолчанию) -->
                <div id="photo-form-container" class="mb-4 p-3 bg-light border rounded" style="display: none;">
                    <form id="photo-form" enctype="multipart/form-data">
                        <div class="mb-2">
                            <label for="photo" class="form-label">Выберите новое фото:</label>
                            <input type="file" class="form-control" name="photo" accept="image/*" required>
                        </div>
                        <button type="submit" class="btn btn-success btn-sm me-2">
                            <i class="fas fa-upload"></i> Загрузить
                        </button>
                        <button type="button" class="btn btn-secondary btn-sm cancel-upload">
                            <i class="fas fa-times"></i> Отмена
                        </button>
                    </form>
                </div>
            </div>
            <div class="col-md-8">
                <h2>{{ user_name }}</h2>
                <p><strong>Город:</strong> {{ user_city }}</p>
                <p><strong>Хобби:</strong> {{ user_hobby }}</p>
                <p><strong>Возраст:</strong> {{ user_age }}</p>
                <a href="{{ url_for('edit_profile') }}" class="btn btn-secondary">
                    <i class="fas fa-pencil-alt"></i> Редактировать
                </a>
            </div>
        </div>

        <hr>

        <!-- Форма редактирования профиля -->
        <h3>Редактировать данные</h3>
        <form method="POST" action="{{ url_for('edit_profile') }}">
            <div class="form-group">
                <label for="name">Имя:</label>
                <input type="text" class="form-control" id="name" name="name" value="{{ user_name }}" required>
            </div>
            <div class="form-group">
                <label for="city">Город:</label>
                <input type="text" class="form-control" id="city" name="city" value="{{ user_city }}" required>
            </div>
            <div class="form-group">
                <label for="hobby">Хобби:</label>
                <input type="text" class="form-control" id="hobby" name="hobby" value="{{ user_hobby }}" required>
            </div>
            <div class="form-group">
                <label for="age">Возраст:</label>
                <input type="number" class="form-control" id="age" name="age" value="{{ user_age }}" required>
            </div>
            <button type="submit" class="btn btn-primary">Сохранить изменения</button>
        </form>
    </div>

     <!-- Подключение JavaScript для обработки AJAX -->
    <script>
        // Показываем форму при клике на "Обновить фото"
        document.getElementById('update-photo-btn').addEventListener('click', function(event) {
            event.preventDefault(); // Предотвращаем переход по ссылке
            document.getElementById('photo-form-container').style.display = 'block';
        });

        // Скрываем форму при клике на "Отмена"
        document.querySelector('.cancel-upload').addEventListener('click', function() {
            document.getElementById('photo-form-container').style.display = 'none';
        });

        // Обработка отправки формы (AJAX)
        document.getElementById('photo-form').addEventListener('submit', function(event) {
            event.preventDefault(); // Не перезагружаем страницу

            const formData = new FormData(this);

            fetch('{{ url_for("update_photo") }}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Обновляем аватар пользователя
                    document.querySelector('img[alt="Фото пользователя"]').src = data.photo_url;
                    alert('✅ Фото успешно обновлено!');
                } else {
                    alert('❌ Ошибка при обновлении фото.');
                }
                document.getElementById('photo-form-container').style.display = 'none';
            })
            .catch(error => {
                console.error('Ошибка:', error);
                alert('⚠️ Произошла ошибка при загрузке фото.');
            });
        });
    </script>
{% endblock %}